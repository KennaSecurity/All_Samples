import pandas as pd
import json
import requests
import os
import sys

#Update the base_url string below if your Kenna account is on any platform other than Prod 1
base_url = "https://api.kennasecurity.com/"

cisa_df = pd.read_csv("https://www.cisa.gov/sites/default/files/csv/known_exploited_vulnerabilities.csv")
cisa_df = cisa_df
cisa_df.columns = cisa_df.columns.str.strip("\u200b")
cisa_df = cisa_df.applymap(lambda x: x.strip() if isinstance(x, str) else x)

cves = cisa_df["cveID"].to_list()

headers = {'X-Risk-Token':os.environ.get("kenna_api_key")}
CISA_List = []

print(f"Compiling Kenna risk scores...")
for cve in cves:

    url = f"{base_url}vulnerability_definitions/{cve}"
    
    try:
        r = requests.get(url, headers=headers)
        data = r.json()
    except ConnectionError:
        print(f"Connection error detected. Please try again.")
        sys.exit(1)

    risk_meter_score = data['vulnerability_definition']['risk_meter_score']
    active_internet_breach = data['vulnerability_definition']['active_internet_breach']
    velocity_month = data['vulnerability_definition']['velocity_month']
    cvss_score = data['vulnerability_definition']['cvss_score']
    easily_exploitable = data['vulnerability_definition']['easily_exploitable']   
    cvss_access_vector = data['vulnerability_definition']['cvss_access_vector']  
    malware_exploitable = data['vulnerability_definition']['malware_exploitable']   
    remote_code_execution = data['vulnerability_definition']['remote_code_execution']

    CISA_List_Temp = (cve, risk_meter_score, cvss_score, easily_exploitable, active_internet_breach, cvss_access_vector, malware_exploitable, remote_code_execution)
    CISA_List.append(CISA_List_Temp)

    cisa_kenna_df = pd.DataFrame(CISA_List, columns = ["CVE", "KennaScore","CVSSScore", "EasilyExploitable", "AIB", "Vector", "MalwareExploitable", "RCE"])

    cisa_df.rename(columns = {'cveID':'CVE'}, inplace = True)
    cisa_df.rename(columns = {'dateAdded':'AddedToCISAList'}, inplace = True)

cisa_df['CVE'] = cisa_df['CVE'].astype(str)
cisa_kenna_df['CVE'] = cisa_kenna_df['CVE'].astype(str)
cisa_kenna_df = cisa_kenna_df.sort_values(by=['CVE'])
cisa_df = cisa_df.sort_values(by=['CVE'])
cisa_df['CVE'].isin(cisa_kenna_df['CVE']).value_counts()

cisa_data = cisa_kenna_df.merge(cisa_df, on='CVE', how='outer')

cisa_data = cisa_data.drop(columns=['vendorProject', 'product', 'vulnerabilityName', 'shortDescription', 'requiredAction', 'dueDate', 'notes'])

cisa_data.to_csv("CISA_Exploited_Vulns_with_Risk_Scores.csv")

print(f"CISA_Exploited_Vulns_with_Risk_scores.csv is now available")
